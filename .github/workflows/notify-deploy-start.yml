name: 'Deploy Start Slack Notification'

on:
  workflow_call:
    inputs:
      webhook_url:
        description: 'Slack Webhook URL'
        required: true
        type: string
      project_name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå'
        required: true
        type: string
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ (development/production)'
        required: true
        type: string
      pr_title:
        description: 'PRã‚¿ã‚¤ãƒˆãƒ«'
        required: false
        type: string
        default: ${{ github.event.pull_request.title }}
      pr_url:
        description: 'PR URL'
        required: false
        type: string
        default: ${{ github.event.pull_request.html_url }}
      author:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œè€…'
        required: false
        type: string
        default: ${{ github.actor }}
      action_url:
        description: 'å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®URL'
        required: false
        type: string
        default: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    outputs:
      thread_ts:
        description: 'Slackã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµæžœé€šçŸ¥ç”¨ï¼‰'
        value: ${{ jobs.notify.outputs.thread_ts }}

jobs:
  notify:
    runs-on: ubuntu-latest
    outputs:
      thread_ts: ${{ steps.slack_response.outputs.thread_ts }}
    steps:
      - name: Checkout slack-integration
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/slack-integration
          path: slack-integration

      - name: Generate environment message
        id: env_message
        run: |
          case "${{ inputs.environment }}" in
            "production")
              echo "env_text=æœ¬ç•ªç’°å¢ƒ" >> $GITHUB_OUTPUT
              echo "message=ðŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ï¼" >> $GITHUB_OUTPUT
              ;;
            "development")
              echo "env_text=é–‹ç™ºç’°å¢ƒ" >> $GITHUB_OUTPUT
              echo "message=ðŸ”§ é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "env_text=${{ inputs.environment }}" >> $GITHUB_OUTPUT
              echo "message=ðŸ“¦ ${{ inputs.environment }}ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send deploy start notification
        id: slack_response
        uses: ./slack-integration/.github/actions/slack-notify
        with:
          webhook_url: ${{ inputs.webhook_url }}
          user_id: ${{ inputs.author }}
          project_name: '${{ inputs.project_name }} (${{ steps.env_message.outputs.env_text }})'
          pr_title: ${{ inputs.pr_title }}
          pr_url: ${{ inputs.pr_url }}
          workflow_action: 'ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹'
          action_url: ${{ inputs.action_url }}
          message: ${{ steps.env_message.outputs.message }}
          status: 'started'

      - name: Extract thread timestamp
        id: extract_ts
        run: |
          # Slack APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰thread_tsã‚’æŠ½å‡ºã™ã‚‹å‡¦ç†
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Slackã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æžã—ã¦thread_tsã‚’å–å¾—
          echo "thread_ts=$(date +%s).000000" >> $GITHUB_OUTPUT