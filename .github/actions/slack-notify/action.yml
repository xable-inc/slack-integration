name: 'Slack Notification'
description: 'Send structured Slack notifications'
author: 'Xable'

inputs:
  webhook_url:
    description: 'Slack Webhook URL'
    required: true
  user_id:
    description: 'GitHub user ID (for mention mapping)'
    required: false
    default: ${{ github.event.pull_request.user.login || github.actor }}
  project_name:
    description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå'
    required: true
  pr_title:
    description: 'PRã‚¿ã‚¤ãƒˆãƒ«'
    required: false
    default: ${{ github.event.pull_request.title }}
  pr_url:
    description: 'PR URL'
    required: false
    default: ${{ github.event.pull_request.html_url }}
  workflow_action:
    description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å'
    required: false
    default: ${{ github.workflow }}
  action_url:
    description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ URL'
    required: false
    default: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  message:
    description: 'ã‚»ãƒªãƒ•/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
    required: false
    default: ''
  status:
    description: 'çµæœ (success/failure/cancelled/started)'
    required: true
  thread_ts:
    description: 'Slackã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆè¿”ä¿¡ç”¨ï¼‰'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Map GitHub user to Slack user
      id: user_mapping
      shell: bash
      run: |
        case "${{ inputs.user_id }}" in
          "c-markz")
            echo "slack_user=<@Mark Takada>" >> $GITHUB_OUTPUT
            ;;
          # ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã“ã“ã«è¿½åŠ 
          *)
            echo "slack_user=${{ inputs.user_id }}" >> $GITHUB_OUTPUT
            ;;
        esac


    - name: Generate status message
      id: status_message
      shell: bash
      run: |
        case "${{ inputs.status }}" in
          "success")
            echo "color=good" >> $GITHUB_OUTPUT
            echo "status_text=âœ… æˆåŠŸ" >> $GITHUB_OUTPUT
            ;;
          "failure")
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "status_text=âŒ å¤±æ•—" >> $GITHUB_OUTPUT
            ;;
          "cancelled")
            echo "color=warning" >> $GITHUB_OUTPUT
            echo "status_text=â¹ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«" >> $GITHUB_OUTPUT
            ;;
          "started")
            echo "color=#0099ff" >> $GITHUB_OUTPUT
            echo "status_text=ğŸš€ é–‹å§‹" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "color=#808080" >> $GITHUB_OUTPUT
            echo "status_text=ğŸ“‹ ${{ inputs.status }}" >> $GITHUB_OUTPUT
            ;;
        esac

    - name: Send Slack notification
      shell: bash
      run: |
        # Slackãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        cat << 'EOF' > payload.json
        {
        EOF

        # ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
        if [ -n "${{ inputs.thread_ts }}" ]; then
          echo '"thread_ts": "${{ inputs.thread_ts }}",' >> payload.json
        fi

        cat << 'EOF' >> payload.json
          "attachments": [
            {
              "color": "${{ steps.status_message.outputs.color }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ inputs.project_name }} - ${{ steps.status_message.outputs.status_text }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*æ‹…å½“è€…:*\n${{ steps.user_mapping.outputs.slack_user }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:*\n<${{ inputs.action_url }}|${{ inputs.workflow_action }}>"
                    }
                  ]
                }
        EOF

        # PRã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
        if [ -n "${{ inputs.pr_title }}" ] && [ -n "${{ inputs.pr_url }}" ]; then
          cat << 'EOF' >> payload.json
                ,{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR:* <${{ inputs.pr_url }}|${{ inputs.pr_title }}>"
                  }
                }
        EOF
        fi

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
        if [ -n "${{ inputs.message }}" ]; then
          cat << 'EOF' >> payload.json
                ,{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ inputs.message }}"
                  }
                }
        EOF
        fi

        # JSONã‚’é–‰ã˜ã‚‹
        cat << 'EOF' >> payload.json
              ]
            }
          ]
        }
        EOF

        # Slackã«é€ä¿¡
        curl -X POST -H 'Content-type: application/json' \
          --data @payload.json \
          "${{ inputs.webhook_url }}"